# –¢–µ—Å—Ç–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è: PHP/Symfony Developer (Backend)

-----

## üöÄ –ó–∞–¥–∞—á–∞: –†–æ–∑—Ä–æ–±–∫–∞ —Å–µ—Ä–≤—ñ—Å—É –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –∫–≤–∏—Ç–∫—ñ–≤

–ù–µ–æ–±—Ö—ñ–¥–Ω–æ —Ä–æ–∑—Ä–æ–±–∏—Ç–∏ –±–µ–∫–µ–Ω–¥-—Å–µ—Ä–≤—ñ—Å (API) –¥–ª—è –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –∫–≤–∏—Ç–∫—ñ–≤ –Ω–∞ –ø–æ–¥—ñ—ó.

### üìà –ë—ñ–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç

1.  –£ —Å–∏—Å—Ç–µ–º—ñ —ñ—Å–Ω—É—é—Ç—å **–ü–æ–¥—ñ—ó** (`Event`).
2.  –ö–æ–∂–Ω–∞ –ü–æ–¥—ñ—è –º–∞—î **–æ–±–º–µ–∂–µ–Ω—É** –∑–∞–≥–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–≤–∏—Ç–∫—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 100 –º—ñ—Å—Ü—å).
3.  –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –º–æ–∂—É—Ç—å –±—Ä–æ–Ω—é–≤–∞—Ç–∏ –∫–≤–∏—Ç–∫–∏ –Ω–∞ —Ü—ñ –ø–æ–¥—ñ—ó.
4.  –°–∏—Å—Ç–µ–º–∞ **–Ω—ñ–∫–æ–ª–∏** –Ω–µ –ø–æ–≤–∏–Ω–Ω–∞ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –∑–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏ –±—ñ–ª—å—à–µ –∫–≤–∏—Ç–∫—ñ–≤, –Ω—ñ–∂ –¥–æ—Å—Ç—É–ø–Ω–æ.
5.  –ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î –æ—Ç—Ä–∏–º–∞—Ç–∏ email-–ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.

-----

## üìã –û—Å–Ω–æ–≤–Ω—ñ –≤–∏–º–æ–≥–∏ (API)

–†–µ–∞–ª—ñ–∑—É–π—Ç–µ —î–¥–∏–Ω–∏–π REST API –µ–Ω–¥–ø–æ—ñ–Ω—Ç:

`POST /api/events/{eventId}/book`

#### –¢—ñ–ª–æ –∑–∞–ø–∏—Ç—É (Request Body):

```json
{
    "clientId": "598986bc-d31e-495a-aa88-d7236d625852",
    "clientEmail": "test@example.com"
}
```

#### –£—Å–ø—ñ—à–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å (HTTP 202 Accepted):

```json
{
  "status": "booking_accepted",
  "message": "Your booking is being processed."
}
```

#### –í—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑ –ø–æ–º–∏–ª–∫–∞–º–∏:

* **HTTP 400 Bad Request:** –Ø–∫—â–æ –ø–æ–¥—ñ—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –∞–±–æ –∫–≤–∏—Ç–∫–∏ –Ω–∞ –Ω–µ—ó –∑–∞–∫—ñ–Ω—á–∏–ª–∏—Å—è (`{"error": "No tickets left"}`).
* **HTTP 409 Conflict:** (–î–∏–≤. –≤–∏–º–æ–≥—É –ø—Ä–æ "Race Condition").

-----

## üõ†Ô∏è –¢–µ—Ö–Ω—ñ—á–Ω—ñ –≤–∏–º–æ–≥–∏ (–ö–ª—é—á–æ–≤–µ)

1.  **–§—Ä–µ–π–º–≤–æ—Ä–∫:** –ü—Ä–æ—î–∫—Ç –º–∞—î –±—É—Ç–∏ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –Ω–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π LTS-–≤–µ—Ä—Å—ñ—ó **Symfony**.

2.  **–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ (DDD):** –ú–∏ –æ—á—ñ–∫—É—î–º–æ –ø–æ–±–∞—á–∏—Ç–∏ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É, –ø–æ–±—É–¥–æ–≤–∞–Ω—É –∑–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º–∏ **Domain-Driven Design (DDD)**.

    * –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ "—á–∏ –º–æ–∂–Ω–∞ –∑–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏ –∫–≤–∏—Ç–æ–∫?") –º–∞—î –±—É—Ç–∏ —ñ–Ω–∫–∞–ø—Å—É–ª—å–æ–≤–∞–Ω–∞ –≤ **–î–æ–º–µ–Ω–Ω–æ–º—É —à–∞—Ä—ñ** (`Domain`).
    * –î–æ–º–µ–Ω–Ω—ñ —Å—É—Ç–Ω–æ—Å—Ç—ñ (`Event`, `Booking`) –º–∞—é—Ç—å —Å–∞–º—ñ –∑–∞—Ö–∏—â–∞—Ç–∏ —Å–≤–æ—ó –ø—Ä–∞–≤–∏–ª–∞ (—ñ–Ω–≤–∞—Ä—ñ–∞–Ω—Ç–∏).
    * –ö–æ–¥ –¥–æ–º–µ–Ω–Ω–æ–≥–æ —à–∞—Ä—É –Ω–µ –ø–æ–≤–∏–Ω–µ–Ω –∑–∞–ª–µ–∂–∞—Ç–∏ –≤—ñ–¥ Symfony, Doctrine —á–∏ –±—É–¥—å-—è–∫–æ—ó —ñ–Ω—à–æ—ó —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∏.

3.  **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ—Å—Ç—å (RabbitMQ):**

    * –í—ñ–¥–ø—Ä–∞–≤–∫–∞ email-–ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è ‚Äî —Ü–µ –ø–æ–≤—ñ–ª—å–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è, —è–∫–∞ –Ω–µ –ø–æ–≤–∏–Ω–Ω–∞ –±–ª–æ–∫—É–≤–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É.
    * –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ **Symfony Messenger** –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—ó –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ email.
    * –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–µ—Ä–≥—É **RabbitMQ** –º–∞—î –ø–æ—Ç—Ä–∞–ø–ª—è—Ç–∏ **—Ç—ñ–ª—å–∫–∏** –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∫–æ–º—ñ—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö.
    * *–°–∏–º—É–ª—è—Ü—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏:* –î–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç–∏ `sleep(5)` —Ç–∞ –ª–æ–≥ —É –æ–±—Ä–æ–±–Ω–∏–∫—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.

4.  **–û–±—Ä–æ–±–∫–∞ "Race Condition" (–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è):**

    * –í–∞—à —Å–µ—Ä–≤—ñ—Å –º–∞—î –±—É—Ç–∏ —Å—Ç—ñ–π–∫–∏–º –¥–æ –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤.
    * **–ü—Ä–æ–±–ª–µ–º–∞:** –©–æ —Å—Ç–∞–Ω–µ—Ç—å—Å—è, —è–∫—â–æ –Ω–∞ 1 –æ—Å—Ç–∞–Ω–Ω—ñ–π –∫–≤–∏—Ç–æ–∫ –æ–¥–Ω–æ—á–∞—Å–Ω–æ –ø—Ä–∏–π–¥–µ 100 –∑–∞–ø–∏—Ç—ñ–≤? –ü—Ä–æ–¥–∞–Ω–∏–π –º–∞—î –±—É—Ç–∏ –ª–∏—à–µ –æ–¥–∏–Ω, –∞ —Ä–µ—à—Ç–∞ 99 –º–∞—é—Ç—å –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–º–∏–ª–∫—É.
    * –í–∏ –º–∞—î—Ç–µ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –º–µ—Ö–∞–Ω—ñ–∑–º –¥–ª—è –≤–∏—Ä—ñ—à–µ–Ω–Ω—è —Ü—ñ—î—ó –ø—Ä–æ–±–ª–µ–º–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, **Optimistic/Pessimistic Locking**).
    * –Ø–∫—â–æ –∑–∞–ø–∏—Ç "–ø—Ä–æ–≥—Ä–∞–≤ –≥–æ–Ω–∏—Ç–≤—É" (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —á–µ—Ä–µ–∑ `OptimisticLockException`), –≤—ñ–Ω –º–∞—î –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å `HTTP 409 Conflict` –∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º `{"error": "Sorry, someone just booked the last ticket. Please try again."}`.

5.  **–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö:** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ **PostgreSQL**. –°—Ö–µ–º—É –¥–∞–Ω–∏—Ö —Ä–æ–∑—Ä–æ–±—ñ—Ç—å —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ (–¥–æ—Å—Ç–∞—Ç–Ω—å–æ 2-3 —Ç–∞–±–ª–∏—Ü—å).

6.  **–û—Ç–æ—á–µ–Ω–Ω—è:** –ü—Ä–æ—î–∫—Ç –º–∞—î –±—É—Ç–∏ –ø–æ–≤–Ω—ñ—Å—Ç—é –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –¥–ª—è –∑–∞–ø—É—Å–∫—É —á–µ—Ä–µ–∑ `docker compose up` (PHP-FPM, Nginx/Caddy, PostgreSQL, RabbitMQ).

-----

## üèÅ –©–æ –º–∏ –æ—á—ñ–∫—É—î–º–æ –æ—Ç—Ä–∏–º–∞—Ç–∏

1.  –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π (GitHub, GitLab).
2.  –§–∞–π–ª `README.md` –∑ –æ–ø–∏—Å–æ–º:
    * –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –¥–ª—è –∑–∞–ø—É—Å–∫—É –ø—Ä–æ—î–∫—Ç—É.
    * –ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –≤–∞—à–æ–≥–æ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–æ–≥–æ —Ä—ñ—à–µ–Ω–Ω—è.
    * **–ù–∞–π–≥–æ–ª–æ–≤–Ω—ñ—à–µ:** –ü–æ—è—Å–Ω–µ–Ω–Ω—è, —è–∫–∏–π —Å–∞–º–µ –º–µ—Ö–∞–Ω—ñ–∑–º –≤–∏ –æ–±—Ä–∞–ª–∏ –¥–ª—è –≤–∏—Ä—ñ—à–µ–Ω–Ω—è "race condition" —ñ —á–æ–º—É.

-----

## üèÖ –ö—Ä–∏—Ç–µ—Ä—ñ—ó –æ—Ü—ñ–Ω–∫–∏

* **–ß–∏—Å—Ç–æ—Ç–∞ —Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥—É:** –ù–∞—Å–∫—ñ–ª—å–∫–∏ –ª–µ–≥–∫–æ —á–∏—Ç–∞—Ç–∏ —Ç–∞ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –≤–∞—à –∫–æ–¥.
* **–î–æ—Ç—Ä–∏–º–∞–Ω–Ω—è DDD:** –ß–∏ –¥—ñ–π—Å–Ω–æ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞ —ñ–∑–æ–ª—å–æ–≤–∞–Ω–∞ —É –î–æ–º–µ–Ω–Ω–æ–º—É —à–∞—Ä—ñ.
* **–ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å:** –ß–∏ –∫–æ—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∞—Ü—é—î –º–µ—Ö–∞–Ω—ñ–∑–º –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –∑–∞–ø–∏—Ç–∞—Ö.
* **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ—Å—Ç—å:** –ß–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞ —Ä–æ–±–æ—Ç–∞ –∑ —á–µ—Ä–≥–∞–º–∏.
* **–¢–µ—Å—Ç–∏:** –ù–∞—è–≤–Ω—ñ—Å—Ç—å —é–Ω—ñ—Ç-—Ç–µ—Å—Ç—ñ–≤ (–æ—Å–æ–±–ª–∏–≤–æ –¥–ª—è –î–æ–º–µ–Ω–Ω–æ–≥–æ —à–∞—Ä—É) –±—É–¥–µ **–≤–µ–ª–∏—á–µ–∑–Ω–∏–º –ø–ª—é—Å–æ–º**.

-----

# üèÜ –ú–æ—î –†—ñ—à–µ–Ω–Ω—è —Ç–∞ –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó

–ù–∏–∂—á–µ –Ω–∞–≤–µ–¥–µ–Ω–æ –æ–ø–∏—Å –º–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É –¥–æ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Ç–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–ª—è –∑–∞–ø—É—Å–∫—É —Ç–∞ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ—î–∫—Ç—É.

## üèóÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è (DDD)

–Ø —Å—Ç—Ä—É–∫—Ç—É—Ä—É–≤–∞–≤ –ø—Ä–æ—î–∫—Ç –Ω–∞–≤–∫–æ–ª–æ –±—ñ–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç—É `Booking`, –¥–æ—Ç—Ä–∏–º—É—é—á–∏—Å—å –ø—Ä–∏–Ω—Ü–∏–ø—ñ–≤ –±–∞–≥–∞—Ç–æ—à–∞—Ä–æ–≤–æ—ó –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ DDD:

* `src/Booking/Domain`: –°–µ—Ä—Ü–µ –Ω–∞—à–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É. –ú—ñ—Å—Ç–∏—Ç—å —Å—É—Ç–Ω—ñ—Å—Ç—å `Event`, —è–∫–∞ –∑–∞—Ö–∏—â–∞—î —Å–≤–æ—ó –±—ñ–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ (—ñ–Ω–≤–∞—Ä—ñ–∞–Ω—Ç–∏). –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –º–µ—Ç–æ–¥ `Event::bookTicket()` –º—ñ—Å—Ç–∏—Ç—å –ª–æ–≥—ñ–∫—É –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏, —á–∏ —î –≤—ñ–ª—å–Ω—ñ –∫–≤–∏—Ç–∫–∏. –¶–µ–π —à–∞—Ä –Ω–µ –º–∞—î –∂–æ–¥–Ω–∏—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π –≤—ñ–¥ Symfony, Doctrine —á–∏ —ñ–Ω—à–∏—Ö —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—ñ–≤.
* `src/Booking/Application`: –®–∞—Ä-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä. –ú—ñ—Å—Ç–∏—Ç—å "Use Cases" (—É –≤–∏–≥–ª—è–¥—ñ —Å–µ—Ä–≤—ñ—Å—ñ–≤ –∞–±–æ –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –∫–æ–º–∞–Ω–¥). –ù–∞–ø—Ä–∏–∫–ª–∞–¥, `BookingService` –ø—Ä–∏–π–º–∞—î –∫–æ–º–∞–Ω–¥—É, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î —Å—É—Ç–Ω—ñ—Å—Ç—å –∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é, –≤–∏–∫–ª–∏–∫–∞—î —ó—ó –¥–æ–º–µ–Ω–Ω–∏–π –º–µ—Ç–æ–¥ `bookTicket()` —ñ –∑–±–µ—Ä—ñ–≥–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
* `src/Booking/Infrastructure`: –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç–µ—Ö–Ω—ñ—á–Ω–∏—Ö –¥–µ—Ç–∞–ª–µ–π. –¢—É—Ç –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è `DoctrineEventRepository` (—è–∫–∏–π —Ä–µ–∞–ª—ñ–∑—É—î —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑ –î–æ–º–µ–Ω—É), –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è `messenger.yaml` —Ç–∞ –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å `SendConfirmationEmailHandler`.
* `src/UserInterface`: –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É –≤ –¥–æ–¥–∞—Ç–æ–∫. –¶–µ –Ω–∞—à `BookingController`, —è–∫–∏–π –ø—Ä–∏–π–º–∞—î HTTP-–∑–∞–ø–∏—Ç, –≤–∞–ª—ñ–¥—É—î –π–æ–≥–æ, —Å—Ç–≤–æ—Ä—é—î DTO-–∫–æ–º–∞–Ω–¥—É —ñ –ø–µ—Ä–µ–¥–∞—î —ó—ó –≤ Application-—à–∞—Ä.

–¢–∞–∫–∏–π –ø—ñ–¥—Ö—ñ–¥ —Ä–æ–±–∏—Ç—å –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫—É —ñ–∑–æ–ª—å–æ–≤–∞–Ω–æ—é, –ª–µ–≥–∫–æ—é –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –Ω–µ–∑–∞–ª–µ–∂–Ω–æ—é –≤—ñ–¥ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∏.

-----

## ‚ö° –í–∏—Ä—ñ—à–µ–Ω–Ω—è "Race Condition"

–î–ª—è –≤–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ —è –æ–±—Ä–∞–≤ **Optimistic Locking (–û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è)**.

### –ß–æ–º—É —Å–∞–º–µ —Ü–µ–π –ø—ñ–¥—Ö—ñ–¥?

–ü–µ—Å–∏–º—ñ—Å—Ç–∏—á–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è (Pessimistic Locking, `SELECT ... FOR UPDATE`) –±–ª–æ–∫—É—î —Ä—è–¥–æ–∫ —É –±–∞–∑—ñ –¥–∞–Ω–∏—Ö –Ω–∞ —á–∞—Å –≤—Å—ñ—î—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó. –¶–µ –Ω–∞–¥—ñ–π–Ω–æ, –∞–ª–µ –º–æ–∂–µ —Å—Ç–∞—Ç–∏ "–ø–ª—è—à–∫–æ–≤–∏–º –≥–æ—Ä–ª–æ–º" –ø—Ä–∏ –≤–∏—Å–æ–∫–æ–º—É –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ.

–û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø—Ä–∞—Ü—é—î —ñ–Ω–∞–∫—à–µ:

1.  –î–æ —Å—É—Ç–Ω–æ—Å—Ç—ñ `Event` –¥–æ–¥–∞–Ω–æ –ø–æ–ª–µ `version` –∑ –∞—Ç—Ä–∏–±—É—Ç–æ–º `#[ORM\Version]`.
2.  –í–µ—Å—å –ø—Ä–æ—Ü–µ—Å –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è (–æ—Ç—Ä–∏–º–∞–Ω–Ω—è `Event`, –≤–∏–∫–ª–∏–∫ `bookTicket()`, –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è `Event` —Ç–∞ `Booking`) –æ–±–≥–æ—Ä–Ω—É—Ç–∏–π –≤ –æ–¥–Ω—É **—Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é** (`$entityManager->wrapInTransaction(...)`).
3.  –ö–æ–ª–∏ Doctrine –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –æ–Ω–æ–≤–∏—Ç–∏ `Event`, –≤—ñ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞—î –¥–æ `UPDATE` –∑–∞–ø–∏—Ç—É —É–º–æ–≤—É `... WHERE version = X` (–¥–µ X ‚Äî –≤–µ—Ä—Å—ñ—è, —è–∫—É –≤—ñ–Ω –ø—Ä–æ—á–∏—Ç–∞–≤).
4.  –Ø–∫—â–æ –¥–≤–∞ –ø—Ä–æ—Ü–µ—Å–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–ª–∏ `version = 5`, –ø–µ—Ä—à–∏–π, —Ö—Ç–æ –≤–∏–∫–æ–Ω–∞—î `UPDATE`, –æ–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å—ñ—é –¥–æ `6`.
5.  –ö–æ–ª–∏ –¥—Ä—É–≥–∏–π –ø—Ä–æ—Ü–µ—Å —Å–ø—Ä–æ–±—É—î –≤–∏–∫–æ–Ω–∞—Ç–∏ `UPDATE ... WHERE version = 5`, –≤—ñ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ –∂–æ–¥–Ω–æ–≥–æ —Ä—è–¥–∫–∞ (–±–æ –≤–µ—Ä—Å—ñ—è –≤–∂–µ `6`).
6.  Doctrine —Ä–æ–∑–ø—ñ–∑–Ω–∞—î —Ü–µ —è–∫ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç —ñ –≤–∏–∫–∏–¥–∞—î `OptimisticLockException`.
7.  –ú—ñ–π `BookingController` —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ –≤—ñ–¥–ª–æ–≤–ª—é—î —Ü—é –ø–æ–º–∏–ª–∫—É —ñ –ø–æ–≤–µ—Ä—Ç–∞—î `HTTP 409 Conflict`.

–¶–µ–π –ø—ñ–¥—Ö—ñ–¥ –Ω–µ –±–ª–æ–∫—É—î –±–∞–∑—É –¥–∞–Ω–∏—Ö, —î –¥—É–∂–µ —à–≤–∏–¥–∫–∏–º —ñ —ñ–¥–µ–∞–ª—å–Ω–æ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤, –¥–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –º–æ–∂–ª–∏–≤—ñ, –∞–ª–µ –Ω–µ —î –Ω–æ—Ä–º–æ—é.

-----

## ‚öôÔ∏è –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –ø–æ –∑–∞–ø—É—Å–∫—É

–ü—Ä–æ—î–∫—Ç –ø–æ–≤–Ω—ñ—Å—Ç—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–æ–≤–∞–Ω–∏–π –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Docker.

1.  **–ö–ª–æ–Ω—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π:**

    ```bash
    git clone https://github.com/Martyn911/ticket_system.git
    cd ticket_system
    ```

2.  **–ù–∞–ª–∞—à—Ç—É–π—Ç–µ `.env` —Ñ–∞–π–ª:**
    –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º `DATABASE_URL` —Ç–∞ `MESSENGER_TRANSPORT_DSN` —É —Ñ–∞–π–ª—ñ `.env` –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ Docker (—Ç–æ–±—Ç–æ –≤–∫–∞–∑—É—é—Ç—å –Ω–∞ —ñ–º–µ–Ω–∞ —Å–µ—Ä–≤—ñ—Å—ñ–≤ `database` —Ç–∞ `rabbitmq`).

3.  **–ó–∞–ø—É—Å—Ç—ñ—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏:**

    ```bash
    docker compose up -d --build
    ```

    –¶—è –∫–æ–º–∞–Ω–¥–∞ –ø—ñ–¥–Ω—ñ–º–µ PHP-FPM, Nginx, PostgreSQL —Ç–∞ RabbitMQ.

4.  **–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:**

    ```bash
    docker compose exec php-fpm composer install
    ```

5.  **–ó–∞–ø—É—Å—Ç—ñ—Ç—å –º—ñ–≥—Ä–∞—Ü—ñ—ó –±–∞–∑–∏ –¥–∞–Ω–∏—Ö:**

    ```bash
    # 5.1 –°—Ç–≤–æ—Ä–µ–Ω–Ω—è/–º—ñ–≥—Ä–∞—Ü—ñ—è –æ—Å–Ω–æ–≤–Ω–æ—ó –ë–î (–¥–ª—è API)
    docker compose exec php-fpm php bin/console doctrine:migrations:migrate --no-interaction

    # 5.2 –°—Ç–≤–æ—Ä–µ–Ω–Ω—è/–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ—Å—Ç–æ–≤–æ—ó –ë–î (–¥–ª—è PHPUnit)
    docker compose exec php-fpm php bin/console doctrine:database:create --env=test --if-not-exists
    docker compose exec php-fpm php bin/console doctrine:schema:update --force --env=test
    ```

6.  **(–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ) –°—Ç–≤–æ—Ä—ñ—Ç—å —Ç–µ—Å—Ç–æ–≤—É –ü–æ–¥—ñ—é:**
    –î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –º–∞—Ç–∏ –ø–æ–¥—ñ—é –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö. –ú–æ–∂–Ω–∞ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ `database` —Ç–∞ –¥–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å –≤—Ä—É—á–Ω—É, –∞–±–æ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É:

    ```bash
    # –ü—Ä–∏–∫–ª–∞–¥ –∫–æ–º–∞–Ω–¥–∏, —è–∫—â–æ –≤–∏ —ó—ó —Å—Ç–≤–æ—Ä–∏–ª–∏
    docker compose exec php-fpm php bin/console app:create-event "Super Concert" 10
    ```

7.  **–ó–∞–ø—É—Å—Ç—ñ—Ç—å –≤–æ—Ä–∫–µ—Ä –¥–ª—è —á–µ—Ä–≥–∏:**
    –í –æ–∫—Ä–µ–º–æ–º—É —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ –∑–∞–ø—É—Å—Ç—ñ—Ç—å consumer, —è–∫–∏–π –±—É–¥–µ –æ–±—Ä–æ–±–ª—è—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ RabbitMQ:

    ```bash
    docker compose exec php-fpm php bin/console messenger:consume async -vv
    ```

–ü—Ä–æ—î–∫—Ç –≥–æ—Ç–æ–≤–∏–π –¥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è\!

-----
## üõ†Ô∏è –†–æ–±–æ—Ç–∞ –∑ –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –Ø–∫–æ—Å—Ç—ñ –ö–æ–¥—É (PHPStan, PHP-CS-Fixer)

### 1\. –°—Ç–∞—Ç–∏—á–Ω–∏–π –ê–Ω–∞–ª—ñ–∑ (PHPStan)

–ü–µ—Ä–µ–≤—ñ—Ä—è—î –∫–æ–¥ –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –ø–æ–º–∏–ª–æ–∫, –ø–æ–≤'—è–∑–∞–Ω–∏—Ö –∑ —Ç–∏–ø–∞–º–∏, –≤–∏–∫–ª–∏–∫–∞–º–∏ –Ω–µ—ñ—Å–Ω—É—é—á–∏—Ö –º–µ—Ç–æ–¥—ñ–≤ —Ç–æ—â–æ.

```bash
# –ó–∞–ø—É—Å–∫ PHPStan –Ω–∞ 9-–º—É —Ä—ñ–≤–Ω—ñ —Å—Ç—Ä–æ–≥–æ—Å—Ç—ñ –¥–ª—è —Ç–µ–∫ src —Ç–∞ tests
docker compose exec php-fpm ./vendor/bin/phpstan analyse src tests --level 9 --memory-limit=512M
```

### 2\. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∞ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –°—Ç–∞–Ω–¥–∞—Ä—Ç—ñ–≤ –ö–æ–¥—É–≤–∞–Ω–Ω—è (PHP-CS-Fixer)

–ó–∞–±–µ–∑–ø–µ—á—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å –∫–æ–¥—É —Å—Ç–∏–ª—é Symfony.

#### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ (Dry-Run)

–ü–æ–∫–∞–∑—É—î, —è–∫—ñ —Ñ–∞–π–ª–∏ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è, –∞–ª–µ –Ω–µ –∑–º—ñ–Ω—é—î —ó—Ö:

```bash
docker compose exec php-fpm ./vendor/bin/php-cs-fixer fix --dry-run --diff
```

#### –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è (Fix)

**–£–í–ê–ì–ê:** –ö–æ–º–∞–Ω–¥–∞ –º–æ–¥–∏—Ñ—ñ–∫—É—î –≤–∞—à—ñ —Ñ–∞–π–ª–∏.

```bash
docker compose exec php-fpm ./vendor/bin/php-cs-fixer fix
```

-----

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ù–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ

### 1\. –ó–∞–ø—É—Å–∫ –í–æ—Ä–∫–µ—Ä–∞ (–û–±–æ–≤'—è–∑–∫–æ–≤–æ –¥–ª—è –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—ñ)

–í –æ–∫—Ä–µ–º–æ–º—É —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ –∑–∞–ø—É—Å—Ç—ñ—Ç—å consumer, —è–∫–∏–π –±—É–¥–µ –æ–±—Ä–æ–±–ª—è—Ç–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —á–µ—Ä–≥–∏ RabbitMQ (—Å–∏–º—É–ª—è—Ü—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ email). –¶–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è **–Ω–∞—Å–∫—Ä—ñ–∑–Ω–æ–≥–æ** —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É.

```bash
docker compose exec php-fpm php bin/console messenger:consume async -vv
```

### 2\. –ó–∞–ø—É—Å–∫ –Æ–Ω—ñ—Ç- —Ç–∞ –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏—Ö –¢–µ—Å—Ç—ñ–≤

–¢–µ—Å—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –æ–∫—Ä–µ–º—É —Ç–µ—Å—Ç–æ–≤—É –±–∞–∑—É –¥–∞–Ω–∏—Ö (app_test), —ñ–∑–æ–ª—é—é—á–∏ –ª–æ–≥—ñ–∫—É –≤—ñ–¥ –æ—Å–Ω–æ–≤–Ω–∏—Ö –¥–∞–Ω–∏—Ö.
–¶–µ –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ –≤—Å—ñ –∑–º—ñ–Ω–∏, –≤–Ω–µ—Å–µ–Ω—ñ —Ç–µ—Å—Ç–æ–º,
–≤—ñ–¥–∫–æ—á—É—é—Ç—å—Å—è (rollback) –ø—ñ—Å–ª—è –π–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è.
**–ó–∞–ø—É—Å–∫ —É—Å—ñ—Ö —Ç–µ—Å—Ç—ñ–≤:**

```bash
docker compose exec php-fpm php bin/phpunit
```

*–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:* –£—Å—ñ —Ç–µ—Å—Ç–∏ –º–∞—é—Ç—å –ø—Ä–æ–π—Ç–∏ —É—Å–ø—ñ—à–Ω–æ, –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—é—á–∏ –∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å –¥–æ–º–µ–Ω–Ω–æ—ó –ª–æ–≥—ñ–∫–∏ —Ç–∞ –æ–±—Ä–æ–±–∫—É `OptimisticLockException`.

### 3\. –¢–µ—Å—Ç –Ω–∞ Race Condition (–ù–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞–ª—å–Ω–∏–π —Ç–µ—Å—Ç)

–î–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç—ñ–π–∫–æ—Å—Ç—ñ –¥–æ –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—É –∫–æ–º–∞–Ω–¥—É, —è–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø—É—Å–∫–∞—î **Apache Benchmark (`ab`)**.

```bash
# –ó–∞–ø—É—Å–∫ –∫–æ–º–∞–Ω–¥–∏ –¥–ª—è 10 –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
docker compose exec php-fpm php bin/console app:load-test:booking -vv
```

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π –†–µ–∑—É–ª—å—Ç–∞—Ç:**

* **HTTP 202 (Accepted):** –õ–∏—à–µ **–æ–¥–∏–Ω** –∑–∞–ø–∏—Ç (–ø–µ—Ä–µ–º–æ–∂–µ—Ü—å) –±—É–¥–µ —É—Å–ø—ñ—à–Ω–∏–º.
* **HTTP 409 (Conflict):** –ë—ñ–ª—å—à—ñ—Å—Ç—å –∑–∞–ø–∏—Ç—ñ–≤ –æ—Ç—Ä–∏–º–∞—î **409 Conflict** (—á–µ—Ä–µ–∑ `OptimisticLockException`).
* **–ö–æ–Ω—Å–æ–ª—å –í–æ—Ä–∫–µ—Ä–∞:** –ë—É–¥–µ –æ–±—Ä–æ–±–ª–µ–Ω–æ **–ª–∏—à–µ –æ–¥–Ω–µ** –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤—ñ–¥–ø—Ä–∞–≤–∫—É email.

```log
* Complete requests    10    –£—Å—ñ 10 –∑–∞–ø–∏—Ç—ñ–≤ –¥—ñ–π—à–ª–∏ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞.
* Failed requests    9    –î–µ–≤'—è—Ç—å –∑–∞–ø–∏—Ç—ñ–≤ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—è —É—Å–ø—ñ—Ö–æ–º.
* Non-2xx responses    9    –î–µ–≤'—è—Ç—å –∑–∞–ø–∏—Ç—ñ–≤ –æ—Ç—Ä–∏–º–∞–ª–∏ –∫–æ–¥ HTTP, —è–∫–∏–π –Ω–µ —î 2xx (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 409 Conflict –∞–±–æ 400 Bad Request).
```

### 4\. –®–≤–∏–¥–∫–∞ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ API (HTTP-—Ñ–∞–π–ª)

–î–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∫—ñ–Ω—Ü–µ–≤–æ—ó —Ç–æ—á–∫–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ñ–∞–π–ª HTTP-–∑–∞–ø–∏—Ç—É, –¥–æ—Å—Ç—É–ø–Ω–∏–π —É –±—ñ–ª—å—à–æ—Å—Ç—ñ —Å—É—á–∞—Å–Ω–∏—Ö IDE.

* **–§–∞–π–ª:** `rest/api/events/bookPost.http`
* **–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:** –í—ñ–¥–∫—Ä–∏–π—Ç–µ —Ü–µ–π —Ñ–∞–π–ª —É –≤–∞—à—ñ–π IDE —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "Run" –Ω–∞–¥ –∑–∞–ø–∏—Ç–æ–º, –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ –∑–∞–º—ñ–Ω–∏–≤—à–∏ ID –ø–æ–¥—ñ—ó {eventId} –Ω–∞ —Ä–µ–∞–ª—å–Ω–∏–π.

<!-- end list -->

```http
POST http://localhost/api/events/{eventId}/book
Content-Type: application/json

{
    "clientId": "598986bc-d31e-495a-aa88-d7236d625852",
    "clientEmail": "test@example.com"
}
```
