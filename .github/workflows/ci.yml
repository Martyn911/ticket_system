name: CI Checks (PHPStan & CS)

on:
    push:
        branches: [ "main" ] # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –ø—É—à—ñ –≤ –≥—ñ–ª–∫—É main
    pull_request:
        branches: [ "main" ] # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ/–æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ Pull Request

jobs:
    php_quality:
        name: Code Quality Checks
        runs-on: ubuntu-latest

        steps:
            - name: ‚¨áÔ∏è Checkout code
              uses: actions/checkout@v4

            - name: üê≥ Set up Docker Compose
                # –ó–∞–ø—É—Å–∫–∞—î–º–æ –≤–∞—à—ñ —Å–µ—Ä–≤—ñ—Å–∏, —è–∫ –æ–ø–∏—Å–∞–Ω–æ –≤ docker-compose.yml
              run: docker compose up -d --build

            - name: ‚è≥ Wait for services to be ready
                # –ß–µ–∫–∞—î–º–æ –Ω–∞ –ø–æ–≤–Ω—É –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –±–∞–∑–∏ –¥–∞–Ω–∏—Ö —Ç–∞ RabbitMQ
              run: docker compose exec php-fpm sh -c "until nc -z database 5432; do echo Waiting for DB; sleep 1; done;"

            - name: üì¶ Install Composer dependencies
                # –ó–∞–ø—É—Å–∫ Composer –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
              run: docker compose exec php-fpm composer install --no-interaction --prefer-dist

            - name: üíø Run Database Migrations
                # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ö–µ–º–∏ –ë–î –¥–ª—è —Ç–µ—Å—Ç—ñ–≤
              run: docker compose exec php-fpm php bin/console doctrine:migrations:migrate --no-interaction

            - name: ‚öôÔ∏è Clear Symfony Cache
                # –û—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É –ø–µ—Ä–µ–¥ –∞–Ω–∞–ª—ñ–∑–æ–º
              run: docker compose exec php-fpm php bin/console cache:clear

            - name: üõ°Ô∏è Run PHPStan Static Analysis
                # –ó–∞–ø—É—Å–∫ PHPStan. –ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É –Ω–∞ `--memory-limit` —Ç–∞ –ø—Ä—è–º–∏–π —à–ª—è—Ö!
              run: docker compose exec php-fpm ./vendor/bin/phpstan analyse src tests --level 9 --memory-limit=512M

            - name: üé® Run PHP-CS-Fixer Check
                # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ñ–≤ –∫–æ–¥—É–≤–∞–Ω–Ω—è (dry-run). –Ø–∫—â–æ —î –ø–æ—Ä—É—à–µ–Ω–Ω—è, –ø–∞–π–ø–ª–∞–π–Ω –≤–ø–∞–¥–µ.
              run: docker compose exec php-fpm ./vendor/bin/php-cs-fixer fix --dry-run --diff src tests

            # –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ, –∞–ª–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ: –∑–∞–ø—É—Å–∫ PHPUnit —Ç–µ—Å—Ç—ñ–≤
            - name: ‚úÖ Run PHPUnit Tests
              run: docker compose exec php-fpm php bin/phpunit
